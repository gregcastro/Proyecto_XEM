<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Amaretti</title>
  <link rel="stylesheet" type="text/css" href="assets/lib/stroke-7/style.css"/>
  <link rel="stylesheet" type="text/css" href="assets/lib/jquery.nanoscroller/css/nanoscroller.css"/><!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="assets/css/style.css" type="text/css"/>
  </head>
  <body>
    <div class="am-wrapper">
      <nav class="navbar navbar-default navbar-fixed-top am-top-header">
        <h4>RIG Monitor</h4>
      </nav>
      <div class="am-content">
        <div class="main-content">
          <div class="row">
            <div class="col-sm-12">
              <div id="accordion1" class="panel-group accordion">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
<script src="assets/lib/jquery/jquery.min.js" type="application/javascript"></script>
<script src="assets/lib/jquery.nanoscroller/javascripts/jquery.nanoscroller.min.js" type="application/javascript"></script>
<script src="assets/js/main.js" type="application/javascript"></script>
<script src="assets/lib/bootstrap/dist/js/bootstrap.min.js" type="application/javascript"></script>
<script src="assets/lib/moment.js/moment.js"></script>
<script src="assets/lib/moment.js/moment-timezone.js"></script>
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script> -->
<script type="application/javascript">
$(document).ready(function(){
  //initialize the javascript
  App.init();
  GetUsers();
});
function GetUsers(){
  $.ajax({
    url: 'http://localhost:8000/api/rigs/',
    contentType: 'application/json',
    dataType: 'json',
    success: function(data) {
      //alert(data);
      var _user ="";
      var current_email ="";
      var last_email= "";


      $.each(data, function (i, item) {
        current_email = item.rig_email;
        if (current_email!==last_email){
          _user +="<div class='panel panel-default'>";
          _user +="<div class='panel-heading'>";
          _user +="<h4 class='panel-title'><a data-toggle='collapse' data-parent='#accordion1' href='#collapse"+i+"'><i class='icon s7-angle-down'></i>"+item.rig_email+" - <strong id='"+item.rig_email.replace(".", "").replace("@", "")+"_qty_rigs'></strong></a> </h4>";
          _user +="</div>";
          _user +="<div id='collapse"+i+"' class='panel-collapse collapse'>";
          _user +="<div class='panel-body'>";
          _user +="<div class='col-sm-12'>";
          _user +="<div class='widget widget-fullwidth'>";
          _user +="<table class='table table-striped table-fw-widget table-hover table-responsive' id="+item.rig_email.replace(".", "").replace("@", "")+">";                            _user +="<thead>";
          _user +="<tr>";
          _user +="<th width='10%'>Rig name</th>";
          _user +="<th width='10%'>IP addres</th>";
          _user +="<th width='10%'>Hash Rate</th>";
          _user +="<th width='70%'>GPU info eth</th>";
          _user +="<th width='10%'>Last connection</th>";
          _user +="</tr>";
          _user +="</thead>";
          _user +="<tbody class='no-border-x'>";

          _user +="</tbody>";
          _user +="</table>";
          _user +="</div>";
          _user +="</div>";
          _user +="</div>";
          _user +="</div>";
          _user +="</div>";
          $('#accordion1').append(_user);
        }
        _user="";
        last_email = item.rig_email;
      });
    },
    complete: function(data) {
      data = JSON.parse(data.responseText);
      var table_email ="";
      var _rig="";
      var gpu_info="";;
      var e="";
      var e_length = "";
      var total_rigs = 0;
      var offline_rigs =0
      // last_email ="";
      current_email = data[0].rig_email;
      $.each(data, function (i, item) {
        last_email = item.rig_email;
        //Escribo la cantidad de Rigs por usuario.
        _rig +="<tr>";
        _rig +="<td>"+item.rig_name+"</td>";
        _rig +="<td>"+item.rig_lan_ip+"</td>";
        _rig +="<td>"+(item.rig_hashrate/1000).toFixed(2)+"</td>";
        _rig +="<td>";

        //De Aqui en Adelante escribo la informacion de los GPU
        e= $.parseJSON(item.rig_gpu_info_eth);
        // Determino la cantidad de Rigs que tiene el cliente
        e_length = e.length;
        //ex = $.parseJSON(e);
        var _gpu ="";
        _gpu+="<font size='0.5' face='Arial'>";
        _gpu+="<table>";
        _gpu+="<thead>";
        _gpu+="<tr>";
        _gpu+="<th width='3%'></th>";
        for (g = 0; g < e_length; g++){
          _gpu+="<th width='3%'>GPU"+g+"</th>";
        };
        _gpu+="</tr>";
        _gpu+="</thead>";
        _gpu+="<tbody class='no-border-x'>";
        _gpu+="<tr>";
        _gpu+="<td>TÂ°</td>";
        for (x in e) {
          ex = $.parseJSON(e[x])
          _gpu+="<td>"+ex.Temp+"</td>";
        }
        _gpu+="</tr>";
        _gpu+="<tr>";
        _gpu+="<td>mh/s</td>";
        for (x in e) {
          ex = $.parseJSON(e[x])
          _gpu+="<td>"+(parseInt(ex.Mhs)/1000).toFixed(2)+"</td>";
        };
        _gpu+="</tr>";
        _gpu+="<tr>";
        _gpu+="<td>F</td>";
        for (x in e) {
          ex = $.parseJSON(e[x])
          _gpu+="<td>"+ex.Fan+"</td>";
        };
        _gpu+="</tr>";
        _gpu+="</tbody>";
        _gpu+="</table>";
        _gpu+="</font>";

        _rig+= _gpu;

        _gpu ="";
        _rig +="</td>";
        var last = new Date(item.rig_last_connection*1000);
        last = convertUTCDateToLocalDate(new Date(item.rig_last_connection*1000));
        var now = new Date();
        var diff = diff_minutes(last, now);
        var t = "";
        var diff_display ="";
        if (diff < 60){
          t = "Min";
          diff_display =diff;
        }
        if (diff > 60 && diff < 1440){
          diff_display = diff/60;
          t = "Hours";
        }
        if (diff > 1440){
          diff_display = diff/1440;
          t = "days";
        }

        if (diff > 20){
          _rig +="<td class='text-danger'>"+parseInt(diff_display)+" "+t+" ago</td>";
          offline_rigs++;
        }
        else{
          _rig +="<td class='text-success'>"+parseInt(diff_display)+" min ago</td>";
        }
        _rig +="</tr>";
        table_email = item.rig_email.replace(".", "").replace("@", "");


        if (current_email == last_email){
          total_rigs++;
          // $('#'+item.rig_email.replace(".", "").replace("@", "")+'_qty_rigs').text(total_rigs);
          $('#'+item.rig_email.replace(".", "").replace("@", "")+'_qty_rigs').text((total_rigs-offline_rigs)+"/"+total_rigs);

        }
        else{
          current_email = item.rig_email;
          total_rigs =1;
          offline_rigs = 1;
          $('#'+item.rig_email.replace(".", "").replace("@", "")+'_qty_rigs').text(offline_rigs+"/"+total_rigs);
          total_rigs =0;
        }


        $('#'+table_email+'>tbody').append(_rig);
        e="";
        e_length ="";
        _rig ="";
      });
    }
  });
}

function diff_minutes(dt2, dt1)
{

  var diff =(dt2.getTime() - dt1.getTime()) / 1000;
  diff /= 60;
  return Math.abs(Math.round(diff));

}
function convertUTCDateToLocalDate(date) {
  var newDate = new Date(date.getTime()+date.getTimezoneOffset()*60);

  var offset = date.getTimezoneOffset() / 60;
  var hours = date.getHours();

  newDate.setHours(hours - offset);

  return newDate;
}

</script>
</body>
</html>
